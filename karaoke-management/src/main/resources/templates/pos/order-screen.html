<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="layout/main-layout :: layout('Gọi món', 'pos', ~{::pageHead}, ~{::section})">

<th:block th:fragment="pageHead">
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 8px 30px rgba(15, 23, 42, .06);
      --radius: 16px;

      --primary:#111827;
      --primary-2:#0f172a;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
      --info:#3b82f6;
    }

    .pos-wrap { display:flex; flex-direction:column; gap:14px; }
    .pos-top {
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px; flex-wrap:wrap;
    }
    .pos-title h2{ margin:0; font-size:22px; }
    .pos-title .sub{ color:var(--muted); margin-top:4px; font-size:13px; }

    .pos-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h3{ margin:0 0 10px 0; font-size:16px; }
    .grid-info{
      display:grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap:12px;
    }
    @media (max-width: 1000px){ .grid-info{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid-info{ grid-template-columns: 1fr;} }

    .info-item .label{ color:var(--muted); font-size:12px; margin-bottom:4px; }
    .info-item .value{ font-weight:600; color:var(--text); }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid var(--border);
      font-size:12px; color:var(--text);
      background:#fff;
    }
    .pill.ok{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); color:#065f46; }
    .pill.muted{ background:#f3f4f6; }
    .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); color:#92400e; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      text-decoration:none;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition: all .15s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 25px rgba(15, 23, 42, .08); }
    .btn-primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn-primary:hover{ background:var(--primary-2); border-color:var(--primary-2); }
    .btn-danger{ border-color: rgba(239,68,68,.55); color:#b91c1c; }
    .btn-danger:hover{ background: rgba(239,68,68,.08); }
    .btn-sm{ padding:6px 10px; border-radius:10px; font-size:12px; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field{ display:flex; flex-direction:column; gap:6px; min-width:180px; }
    .field label{ font-size:12px; color:var(--muted); }
    .field input, .field select{
      padding:9px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.10);
    }

    .table-wrap{ overflow:auto; border-radius:14px; border:1px solid var(--border); }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 820px; }
    thead th{
      position:sticky; top:0;
      background:#f9fafb;
      border-bottom:1px solid var(--border);
      padding:10px;
      font-size:12px;
      color:#374151;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px;
      vertical-align:middle;
      font-size:13px;
      color:var(--text);
      white-space:nowrap;
    }
    tbody tr:hover td{ background:#fcfcfd; }
    tfoot td{
      padding:10px;
      font-weight:700;
      background:#fafafa;
    }

    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .note{ font-size:12px; color:var(--muted); margin-top:8px; }

    .total-box{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      padding:12px;
      border:1px dashed rgba(17,24,39,.20);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(17,24,39,.03), rgba(17,24,39,.01));
    }
    .total-box .big{
      font-size:18px; font-weight:800;
    }

    /* flash message (nếu có) */
    .alert{
      padding:10px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff;
      box-shadow:var(--shadow);
    }
    .alert.error{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); color:#991b1b; }
    .alert.ok{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); color:#065f46; }
  </style>
</th:block>

<section>
  <th:block th:with="ro=${readOnly != null and readOnly == true}">

    <!-- (tuỳ chọn) flash message nếu bạn set RedirectAttributes -->
    <div th:if="${error != null}" class="alert error" th:text="${error}">Có lỗi</div>
    <div th:if="${success != null}" class="alert ok" th:text="${success}">OK</div>

    <div class="pos-wrap">

      <!-- TOP -->
      <div class="pos-top">
        <div class="pos-title">
          <h2>Gọi món</h2>
          <div class="sub">
            <b>Order:</b> <span th:text="${order.id}">0</span>
            &nbsp;•&nbsp;
            <b>Session:</b> <span th:text="${order.roomSession.id}">0</span>
            &nbsp;•&nbsp;
            <b>Trạng thái:</b>
            <span class="pill"
                  th:classappend="${order.status.name() == 'OPEN'} ? ' ok' : ' muted'"
                  th:text="${order.status}">OPEN</span>

            <span th:if="${ro}" class="pill warn">Chế độ xem</span>
          </div>
        </div>

        <div class="pos-actions">
          <a class="btn" th:href="@{/room-sessions}">← Danh sách session</a>
          <a class="btn" th:href="@{/rooms}">Danh sách phòng</a>
          <a class="btn" th:href="@{/invoice/create/{roomSessionId}(roomSessionId=${order.roomSession.id})}">
            Hóa đơn
          </a>
        </div>
      </div>

      <!-- INFO -->
      <div class="card">
        <div class="grid-info">
          <div class="info-item">
            <div class="label">Phòng</div>
            <div class="value" th:text="${order.roomSession.room != null ? order.roomSession.room.name : '—'}">—</div>
          </div>

          <div class="info-item">
            <div class="label">Người tạo</div>
            <div class="value" th:text="${order.createdBy != null ? order.createdBy : '—'}">—</div>
          </div>

          <div class="info-item">
            <div class="label">Thời gian tạo</div>
            <div class="value"
                 th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'HH:mm dd/MM/yyyy') : '—'}">—</div>
          </div>

          <div class="info-item">
            <div class="label">Tổng tiền order</div>
            <div class="value">
              <span class="big"
                    th:text="${order.items != null ? #aggregates.sum(order.items.![lineAmount]) : 0}">0</span>
            </div>
          </div>
        </div>

        <div class="note" th:if="${ro}">
          Order đã chốt / xem lịch sử nên không cho phép thêm/sửa/xóa.
        </div>
      </div>

      <!-- ADD ITEM -->
      <div class="card" th:if="${!ro}">
        <h3>Thêm món</h3>

        <form th:action="@{/pos/sessions/{sid}/order/items(sid=${order.roomSession.id})}"
              method="post" class="row">

          <div class="field" style="min-width:320px;">
            <label>Sản phẩm</label>
            <select name="productId" required>
              <option th:each="p : ${products}"
                      th:value="${p.id}"
                      th:text="${p.name + ' - ' + p.price + (p.unit != null && !#strings.isEmpty(p.unit) ? ' / ' + p.unit : '')}">
              </option>
            </select>
          </div>

          <div class="field" style="min-width:120px;">
            <label>Số lượng</label>
            <input type="number" name="quantity" value="1" min="1" required>
          </div>

          <div class="field" style="min-width:260px; flex:1;">
            <label>Ghi chú</label>
            <input type="text" name="note" placeholder="(tuỳ chọn)">
          </div>

          <div class="field" style="min-width:160px;">
            <label>&nbsp;</label>
            <button class="btn btn-primary" type="submit">+ Thêm</button>
          </div>
        </form>

        <div class="note">Mẹo: Nếu thêm trùng sản phẩm, hệ thống sẽ cộng dồn số lượng (tùy theo service của bạn).</div>
      </div>

      <!-- ITEMS TABLE -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <h3>Danh sách món</h3>
          <div class="total-box">
            <div class="muted">Tổng</div>
            <div class="big"
                 th:text="${order.items != null ? #aggregates.sum(order.items.![lineAmount]) : 0}">0</div>
          </div>
        </div>

        <div th:if="${order.items == null || #lists.isEmpty(order.items)}" class="muted">
          Chưa có món nào.
        </div>

        <div class="table-wrap" th:if="${order.items != null && !#lists.isEmpty(order.items)}">
          <table>
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th>Đơn giá</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
                <th>Ghi chú</th>
                <th class="right">Thao tác</th>
              </tr>
            </thead>

            <tbody>
              <tr th:each="it : ${order.items}">
                <td th:text="${it.product != null ? it.product.name : '—'}">—</td>
                <td th:text="${it.unitPrice}">0</td>

                <!-- Quantity: readOnly => text; OPEN => form update -->
                <td>
                  <span th:if="${ro}" th:text="${it.quantity}">1</span>

                  <form th:if="${!ro}"
                        th:action="@{/pos/order-items/{id}/update(id=${it.id})}"
                        method="post" class="row" style="gap:8px; margin:0;">
                    <input type="hidden" name="sessionId" th:value="${order.roomSession.id}">
                    <input type="number" name="quantity" th:value="${it.quantity}" min="1" required style="width:100px;">
                    <button type="submit" class="btn btn-sm">Cập nhật</button>
                  </form>
                </td>

                <td th:text="${it.lineAmount}">0</td>
                <td th:text="${it.note}">—</td>

                <td class="right">
                  <span th:if="${ro}" class="muted">—</span>

                  <form th:if="${!ro}"
                        th:action="@{/pos/order-items/{id}/delete(id=${it.id})}"
                        method="post" style="display:inline;"
                        onsubmit="return confirm('Xóa món này?');">
                    <input type="hidden" name="sessionId" th:value="${order.roomSession.id}">
                    <button type="submit" class="btn btn-sm btn-danger">Xóa</button>
                  </form>
                </td>
              </tr>
            </tbody>

            <tfoot>
              <tr>
                <td colspan="3" class="right">Tổng</td>
                <td th:text="${#aggregates.sum(order.items.![lineAmount])}">0</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- CLOSE ORDER -->
      <div class="card" th:if="${!ro}">
        <h3>Chốt order</h3>
        <div class="note">
          Sau khi chốt, order chuyển sang <b>CLOSED</b> và không thể sửa (màn xem sẽ ở chế độ read-only).
        </div>

        <form th:action="@{/pos/sessions/{sid}/order/close(sid=${order.roomSession.id})}"
              method="post"
              onsubmit="return confirm('Chốt order? Sau khi chốt sẽ không sửa được.');">
          <button type="submit" class="btn btn-primary">Chốt Order</button>
        </form>
      </div>

    </div>
  </th:block>
</section>
</html>
