<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="layout/main-layout :: layout('Danh s√°ch ph√≤ng', 'rooms', ~{::pageHead}, ~{::section})"
>
  <th:block th:fragment="pageHead">
    <style>
      .rooms-toolbar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .rooms-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .searchbox {
        min-width: 280px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(0, 0, 0, 0.02);
      }
      .muted {
        color: #6b7280;
      }
      .room-name {
        font-weight: 900;
      }
      .room-sub {
        margin-top: 4px;
        font-size: 12px;
        color: #6b7280;
      }
      .money {
        font-variant-numeric: tabular-nums;
        font-weight: 800;
      }
      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .badge {
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 800;
        font-size: 12px;
      }
      .badge-ok {
        background: rgba(34, 197, 94, 0.12);
        color: #15803d;
        border: 1px solid rgba(34, 197, 94, 0.25);
      }
      .badge-warn {
        background: rgba(245, 158, 11, 0.12);
        color: #b45309;
        border: 1px solid rgba(245, 158, 11, 0.25);
      }
      .badge-muted {
        background: rgba(107, 114, 128, 0.1);
        color: #374151;
        border: 1px solid rgba(107, 114, 128, 0.22);
      }

      @media (max-width: 720px) {
        .searchbox {
          min-width: 180px;
          width: 100%;
        }
      }
    </style>
  </th:block>

  <section>
    <div class="topbar">
      <div>
        <h2 class="page-title">Danh s√°ch ph√≤ng</h2>
        <div class="help-text">
          Theo d√µi tr·∫°ng th√°i ph√≤ng, qu·∫£n l√Ω ph√≤ng v√† m·ªü ph√≤ng nhanh.
        </div>
      </div>

      <div style="display: flex; gap: 10px; flex-wrap: wrap">
        <a class="btn btn-primary" th:href="@{/rooms/new}">+ Th√™m ph√≤ng</a>
        <a class="btn btn-outline" th:href="@{/room-sessions}"
          >L·ªãch s·ª≠ m·ªü/ƒë√≥ng</a
        >
      </div>
    </div>

    <div class="card" style="margin-bottom: 12px">
      <div class="rooms-toolbar">
        <div class="rooms-filters">
          <div class="pill searchbox">
            <span class="muted">üîé</span>
            <input
              id="roomSearch"
              class="input"
              type="text"
              placeholder="T√¨m theo t√™n ph√≤ng (VD: P101, VIP1...)"
              style="
                border: none;
                outline: none;
                padding: 0;
                background: transparent;
                width: 100%;
              "
              oninput="filterRooms()"
            />
          </div>

          <div class="pill">
            <span class="muted">Tr·∫°ng th√°i</span>
            <select
              id="statusFilter"
              class="input"
              style="border: none; background: transparent; padding: 0"
              onchange="filterRooms()"
            >
              <option value="">T·∫•t c·∫£</option>
              <option value="AVAILABLE">AVAILABLE</option>
              <option value="OCCUPIED">OCCUPIED</option>
              <option value="MAINTENANCE">MAINTENANCE</option>
            </select>
          </div>
        </div>

        <div class="muted" id="roomCount">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="roomsTable">
          <thead>
            <tr>
              <th style="width: 70px">ID</th>
              <th>T√™n ph√≤ng</th>
              <th>Lo·∫°i ph√≤ng</th>
              <th style="width: 160px; text-align: right">Gi√°/gi·ªù</th>
              <th style="width: 160px">Tr·∫°ng th√°i</th>
              <th style="width: 360px">H√†nh ƒë·ªông</th>
            </tr>
          </thead>

          <tbody>
            <tr th:if="${#lists.isEmpty(rooms)}">
              <td
                colspan="6"
                style="text-align: center; color: #6b7280; padding: 18px"
              >
                Ch∆∞a c√≥ ph√≤ng. H√£y b·∫•m <b>+ Th√™m ph√≤ng</b>.
              </td>
            </tr>

            <tr
              th:each="r : ${rooms}"
              class="room-row"
              th:attr="data-name=${r.name},data-status=${r.status}"
            >
              <td th:text="${r.id}">1</td>

              <td>
                <div class="room-name" th:text="${r.name}">P101</div>
                <div class="room-sub">
                  <span
                    th:text="${r.roomType != null ? r.roomType.name : 'Ch∆∞a g√°n lo·∫°i ph√≤ng'}"
                    >VIP</span
                  >
                  <span> ‚Ä¢ </span>
                  <span th:text="${'S·ª©c ch·ª©a: ' + r.capacity}"
                    >S·ª©c ch·ª©a: 8</span
                  >
                </div>
              </td>

              <td th:text="${r.roomType != null ? r.roomType.name : ''}">
                VIP
              </td>

              <!-- ‚úÖ FIX: format BigDecimal tr·ª±c ti·∫øp, kh√¥ng d√πng Math.round -->
              <td style="text-align: right">
                <span
                  class="money"
                  th:text="${r.roomType != null ? #numbers.formatDecimal(r.roomType.pricePerHour, 0, 'COMMA', 0, 'POINT') + ' ‚Ç´' : ''}"
                >
                  100,000 ‚Ç´
                </span>
              </td>

              <td>
                <span
                  class="badge"
                  th:classappend="
                    ${r.status.name() == 'AVAILABLE'} ? ' badge-ok' :
                    (${r.status.name() == 'OCCUPIED'} ? ' badge-warn' : ' badge-muted')
                  "
                  th:text="${r.status}"
                  >AVAILABLE</span
                >
              </td>

              <td>
                <div class="actions">
                  <form
                    th:if="${r.status.name() == 'AVAILABLE'}"
                    th:action="@{/room-sessions/open}"
                    method="post"
                    style="display: inline"
                    onsubmit="return confirm('M·ªü ph√≤ng n√†y?');"
                  >
                    <input type="hidden" name="roomId" th:value="${r.id}" />
                    <button class="btn btn-primary btn-sm" type="submit">
                      M·ªü ph√≤ng
                    </button>
                  </form>

                  <a
                    class="btn btn-outline btn-sm"
                    th:href="@{/room-sessions}"
                    th:if="${r.status.name() == 'OCCUPIED'}"
                  >
                    Xem session
                  </a>

                  <a
                    class="btn btn-outline btn-sm"
                    th:href="@{'/rooms/edit/' + ${r.id}}"
                  >
                    S·ª≠a
                  </a>

                  <form
                    th:action="@{'/rooms/delete/' + ${r.id}}"
                    method="post"
                    style="display: inline"
                    onsubmit="return confirm('Xo√° ph√≤ng ' + [[${r.name}]] + ' ?');"
                  >
                    <button class="btn btn-outline btn-sm" type="submit">
                      Xo√°
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      function filterRooms() {
        const q = (document.getElementById("roomSearch").value || "")
          .toLowerCase()
          .trim();
        const st = document.getElementById("statusFilter").value || "";

        const rows = Array.from(document.querySelectorAll(".room-row"));
        let visible = 0;

        rows.forEach((r) => {
          const name = (r.getAttribute("data-name") || "").toLowerCase();
          const status = r.getAttribute("data-status") || "";

          const okName = !q || name.includes(q);
          const okStatus = !st || status === st;

          const show = okName && okStatus;
          r.style.display = show ? "" : "none";
          if (show) visible++;
        });

        document.getElementById("roomCount").textContent = visible + " ph√≤ng";
      }
      window.addEventListener("DOMContentLoaded", filterRooms);
    </script>
  </section>
</html>
