<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout/main-layout :: layout('Danh sách hóa đơn', 'invoices', ~{::pageHead}, ~{::section})}"
>
  <th:block th:fragment="pageHead">
    <link rel="stylesheet" th:href="@{/css/invoice-list.css}" />
  </th:block>

  <section>
    <div class="topbar">
      <div>
        <h2 class="page-title">Danh sách hóa đơn</h2>
        <div class="help-text">Lọc theo thời gian, khoảng tiền và phòng.</div>
      </div>
    </div>

    <!-- FILTER -->
    <div class="card filter-card" style="margin-bottom: 14px">
      <form th:action="@{/invoice}" method="get">
        <div class="filter-grid">
          <div class="fg-3">
            <div class="f-label">Từ</div>
            <input
              class="f-input mono"
              type="text"
              name="from"
              th:value="${from}"
              placeholder="HH:mm dd/MM/yyyy"
            />
          </div>

          <div class="fg-3">
            <div class="f-label">Đến</div>
            <input
              class="f-input mono"
              type="text"
              name="to"
              th:value="${to}"
              placeholder="HH:mm dd/MM/yyyy"
            />
          </div>

          <div class="fg-2">
            <div class="f-label">Tối thiểu</div>
            <input
              class="f-input"
              type="number"
              name="min"
              th:value="${min}"
              placeholder="VD: 100000"
              min="0"
              step="1000"
            />
          </div>

          <div class="fg-2">
            <div class="f-label">Tối đa</div>
            <input
              class="f-input"
              type="number"
              name="max"
              th:value="${max}"
              placeholder="VD: 500000"
              min="0"
              step="1000"
            />
          </div>

          <div class="fg-2">
            <div class="f-label">Phòng</div>
            <select class="f-select" name="roomId">
              <option value="" th:selected="${roomId == null}">
                Tất cả phòng
              </option>
              <option
                th:each="r : ${rooms}"
                th:value="${r.id}"
                th:text="${r.name}"
                th:selected="${roomId != null and roomId == r.id}"
              >
                P101
              </option>
            </select>
          </div>

          <div class="fg-12">
            <div class="btn-row">
              <button class="btn btn-primary" type="submit">Lọc</button>
              <a class="btn btn-outline" th:href="@{/invoice}">Xóa lọc</a>
              <!-- Xuất CSV theo đúng bộ lọc hiện tại -->
              <!-- <a
                class="btn btn-outline"
                th:href="@{/invoice/export-excel(from=${from}, to=${to}, min=${min}, max=${max}, roomId=${roomId})}"
              >
                Xuất Excel
              </a> -->

              <a
                class="btn btn-outline"
                th:href="@{/invoice/export(from=${from}, to=${to}, min=${min}, max=${max}, roomId=${roomId})}"
              >
                Xuất Excel
              </a>
            </div>

            <div class="hint">
              Định dạng: <b th:text="${dtPattern}">HH:mm dd/MM/yyyy</b> (VD:
              20:30 26/01/2026)
            </div>

            <!-- Chips: hiển thị điều kiện đang lọc -->
            <div class="chips">
              <span class="chip" th:if="${from != null and !from.isBlank()}">
                Từ: <b th:text="${from}">...</b>
              </span>
              <span class="chip" th:if="${to != null and !to.isBlank()}">
                Đến: <b th:text="${to}">...</b>
              </span>
              <span class="chip" th:if="${min != null}">
                Min: <b th:text="${min}">0</b>
              </span>
              <span class="chip" th:if="${max != null}">
                Max: <b th:text="${max}">0</b>
              </span>
              <span class="chip" th:if="${roomId != null}">
                Phòng ID: <b th:text="${roomId}">1</b>
              </span>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width: 80px">ID</th>
              <th style="width: 110px">Session</th>
              <th>Phòng</th>
              <th class="t-right" style="width: 160px">Tổng tiền</th>
              <th style="width: 190px">Tạo lúc</th>
              <th style="width: 140px">Trạng thái</th>
              <th style="width: 190px">Thanh toán lúc</th>
              <th style="width: 140px">Hành động</th>
            </tr>
          </thead>

          <tbody>
            <tr th:if="${#lists.isEmpty(invoices)}">
              <td
                colspan="8"
                style="text-align: center; color: #6b7280; padding: 18px"
              >
                Không có hóa đơn phù hợp bộ lọc.
              </td>
            </tr>

            <tr th:each="inv : ${invoices}">
              <td th:text="${inv.id}">1</td>

              <td
                class="mono"
                th:text="${inv.roomSession != null ? inv.roomSession.id : ''}"
              >
                3
              </td>

              <td
                style="font-weight: 900"
                th:text="${inv.roomSession != null and inv.roomSession.room != null ? inv.roomSession.room.name : ''}"
              >
                VIP1
              </td>

              <!-- Money: safe format -->
              <td class="t-right" style="font-weight: 900">
                <span
                  th:text="${inv.totalAmount != null
                    ? #numbers.formatDecimal(inv.totalAmount, 0, 'COMMA', 0, 'POINT') + ' ₫'
                  : ''}"
                  >203,333 đ</span
                >
              </td>

              <!-- Date: safe format -->
              <td
                class="mono"
                th:text="${inv.createdAt != null
                    ? T(java.time.format.DateTimeFormatter).ofPattern('HH:mm dd/MM/yyyy').format(inv.createdAt)
                    : ''}"
              >
                23:09 28/01/2026
              </td>

              <td>
                <span
                  class="badge"
                  th:classappend="${inv.status != null and inv.status.name() == 'PAID'} ? ' badge-ok'
                    : (${inv.status != null and inv.status.name() == 'UNPAID'} ? ' badge-warn' : ' badge-bad')"
                  th:text="${inv.status}"
                  >PAID</span
                >
              </td>

              <td
                class="mono"
                th:text="${inv.paidAt != null
                    ? T(java.time.format.DateTimeFormatter).ofPattern('HH:mm dd/MM/yyyy').format(inv.paidAt)
                    : ''}"
              >
                23:09 28/01/2026
              </td>

              <td class="t-center">
                <a
                  class="btn btn-outline btn-sm"
                  th:href="@{'/invoice/' + ${inv.id}}"
                  >Chi tiết</a
                >
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</html>
