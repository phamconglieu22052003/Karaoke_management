<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="layout/main-layout :: layout('Chi tiết hóa đơn', 'invoices', ~{::pageHead}, ~{::section})"
>
  <th:block th:fragment="pageHead"></th:block>

  <section>
    <div class="topbar">
      <div>
        <h2 class="page-title">Chi tiết hóa đơn</h2>
        <div class="help-text">
          Theo dõi trạng thái và thực hiện thanh toán.
        </div>
      </div>
      <a class="btn btn-outline" th:href="@{/invoice}">← Danh sách hóa đơn</a>
    </div>

    <div class="form-row">
      <div class="card">
        <h3 style="margin-top: 0">Thông tin hóa đơn</h3>
        <div class="hr"></div>

        <div class="kv">
          <div class="kv-row">
            <div class="kv-k">ID</div>
            <div class="kv-v" th:text="${invoice.id}">1</div>
          </div>
          <div class="kv-row">
            <div class="kv-k">Session</div>
            <div
              class="kv-v"
              th:text="${invoice.roomSession != null ? invoice.roomSession.id : ''}"
            >
              17
            </div>
          </div>
          <div class="kv-row">
            <div class="kv-k">Tổng tiền</div>
            <div class="kv-v">
              <b th:text="${invoice.totalAmount}">0</b> VND
            </div>
          </div>
          <div class="kv-row">
            <div class="kv-k">Trạng thái</div>
            <div class="kv-v">
              <span
                class="badge"
                th:classappend="${invoice.status.name() == 'PAID'} ? ' badge-ok' : ' badge-muted'"
                th:text="${invoice.status}"
              >
                UNPAID
              </span>
            </div>
          </div>

          <div class="kv-row" th:if="${invoice.paidAt != null}">
            <div class="kv-k">Đã thanh toán lúc</div>
            <div
              class="kv-v"
              th:text="${invoice.paidAt != null ? #temporals.format(invoice.paidAt, 'HH:mm dd/MM/yyyy') : '--'}"
            >
              time
            </div>
          </div>

          <div class="kv-row" th:if="${invoice.vnpTransactionNo != null}">
            <div class="kv-k">Mã giao dịch</div>
            <div class="kv-v" th:text="${invoice.vnpTransactionNo}">xxx</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top: 0">Thanh toán</h3>
        <div class="help-text" style="margin-top: 6px">
          Chỉ hiển thị khi hóa đơn chưa ở trạng thái <b>PAID</b>.
        </div>

        <div class="hr"></div>

        <div
          th:if="${invoice.status != T(com.karaoke_management.entity.InvoiceStatus).PAID}"
        >
          <div class="form-actions">
            <form
              th:action="@{/payment/vnpay/create}"
              method="post"
              style="margin: 0"
            >
              <input type="hidden" name="invoiceId" th:value="${invoice.id}" />
              <button type="submit" class="btn btn-primary">
                Thanh toán VNPay
              </button>
            </form>

            <a
              class="btn btn-outline"
              th:href="@{/payment/vnpay/mock/qr(invoiceId=${invoice.id})}"
            >
              Thanh toán QR (mock)
            </a>
          </div>

          <div class="help-text">
            Mẹo: Nếu bạn dùng QR (mock), trang sẽ tự refresh để cập nhật trạng
            thái sau khi quét.
          </div>
        </div>

        <div
          th:if="${invoice.status == T(com.karaoke_management.entity.InvoiceStatus).PAID}"
        >
          <div
            class="alert"
            style="background: rgba(22, 163, 74, 0.08); color: #166534"
          >
            Hóa đơn đã thanh toán.
          </div>
        </div>
      </div>
    </div>

    <!-- Auto refresh nhẹ mỗi 3s nếu chưa PAID -->
    <script th:inline="javascript">
      const status = /*[[${invoice.status}]]*/ "UNPAID";
      if (status !== "PAID") {
        setTimeout(() => location.reload(), 3000);
      }
    </script>
  </section>
</html>
